import MutationalSignaturesPy.config as c
from MutationalSignaturesPy.functions.virus_functions import *
from MutationalSignaturesPy.functions.mutation_sig import *

import os
from os import path
import random

import pandas as pd

import warnings
warnings.filterwarnings('ignore')

def run_virus_download():

    # Download cosmic mutation data from synapse
    download_virus_mutation_data()

def run_virus_preprocess():

    # Where input data csv is stored
    data_dir = c.DATA_DIR_VIRUS
    combined_data_name = c.COMBINED_VIRUS_DATA_NAME
    
    # Load input data from csv
    covid_mutation_catalog = pd.read_csv(data_dir+'/alphamatrix__covid.csv', sep=",", header=0)
    #flu_mutation_catalog = pd.read_csv(data_dir+'/alphamatrix__flu.csv', sep=",", header=0)

    # Preprocess input data
    covid_preprocessed = preprocess_virus_mutation_catalog(covid_mutation_catalog, 'covid')
    #flu_preprocessed = preprocess_virus_mutation_catalog(flu_mutation_catalog, 'flu')

    print(covid_preprocessed)
    #print(flu_preprocessed)

    # Combined preprocessed data from all four sources
    combined_data = pd.concat([covid_preprocessed])
    #combined_data = pd.concat([covid_preprocessed, flu_preprocessed])

    # Store data combined from all four sources in a csv file locally
    combined_data_path = data_dir+'/'+combined_data_name+'.csv'
    combined_data.to_csv (combined_data_path, index = False, header=True)

    print("Stored at: {}".format(combined_data_path))


def run_virus_gridsearch(
        sources = c.VIRUS_DATA_SOURCE, 
        virus_types = c.VIRUS_TYPE, 
        ignore_mutations_less_than = c.MIN_MUTATION_COUNT,
        write_log_file = c.ENABLE_LOG,
        passes = c.GRIDSEARCH_PASSES, 
        iterations = c.GRIDSEARCH_ITERATIONS, 
        num_topics_range = c.GRIDSEARCH_NUM_TOPICS_RANGE,
        alpha_range = c.GRIDSEARCH_ALPHA_RANGE,
        beta_range = c.GRIDSEARCH_BETA_RANGE,
        random_seed = c.RANDOM_SEED,
        results_dir = c.RESULTS_DIR_VIRUS):

    # Load combined data generated by run_preprocess
    combined_data = load_virus_data()

    # Gridsearch 
    for virus_type in virus_types:

        run_gridsearch_virus_type(
            combined_data,
            sources, 
            virus_type, 
            ignore_mutations_less_than, 
            write_log_file,
            passes, 
            iterations, 
            num_topics_range, 
            alpha_range, 
            beta_range, 
            random_seed,
            results_dir)


def run_gridsearch_virus_type(
        combined_data, 
        sources, 
        virus_type, 
        ignore_mutations_less_than, 
        write_log_file,
        passes, 
        iterations, 
        num_topics_range, 
        alpha_range, 
        beta_range, 
        random_seed,
        results_dir):

    #Recommended format: source <doubleunderscore> data(Eg. source__data)
    model_name = '_'.join(sources)+'__'+virus_type
    # model_name = 'custom__name'

    # Filter input data for each virus type
    filtered_df = filter_virus_data(combined_data, sources, virus_type, ignore_mutations_less_than)

    # Gridsearch and get tuned hyperparameters(k, a, b).
    gridsearch_result = gridsearch(
        filtered_df, 
        model_name, 
        results_dir, 
        write_log_file, 
        passes, 
        iterations, 
        num_topics_range, 
        alpha_range, 
        beta_range, 
        random_seed)


def run_virus_ensemble(        
        sources = c.VIRUS_DATA_SOURCE, 
        virus_types = c.VIRUS_TYPE, 
        ignore_mutations_less_than = c.MIN_MUTATION_COUNT,
        write_log_file = c.ENABLE_LOG,
        passes = c.ENSEMBLE_PASSES, 
        iterations = c.ENSEMBLE_ITERATIONS, 
        num_models = c.ENSEMBLE_NUM_MODELS,
        num_topics = c.TUNED_NUM_TOPICS,
        alpha = c.TUNED_ALPHA,
        beta = c.TUNED_BETA,
        tuned_params_from_gridsearch = c.TUNED_PARAMS_FROM_GRIDSEARCH,
        load_elda_model_from_disk = c.LOAD_ELDA_MODEL_FROM_DISK,
        elda_model_file_path = '',
        random_seed = c.RANDOM_SEED,
        results_dir = c.RESULTS_DIR_VIRUS):

    # Load combined data generated by run_preprocess
    combined_data = load_virus_data()
    
    # Ensemble with tuned parameters
    for virus_type in virus_types:
        run_ensemble_virus_type(
            combined_data,
            sources, 
            virus_type, 
            ignore_mutations_less_than, 
            write_log_file,
            passes, 
            iterations, 
            num_models,
            num_topics,
            alpha,
            beta,
            tuned_params_from_gridsearch,
            load_elda_model_from_disk,
            elda_model_file_path,
            random_seed,
            results_dir)


def run_ensemble_virus_type(
        combined_data,
        sources, 
        virus_type, 
        ignore_mutations_less_than, 
        write_log_file,
        passes, 
        iterations, 
        num_models,
        num_topics,
        alpha,
        beta,
        tuned_params_from_gridsearch,
        load_elda_model_from_disk,
        elda_model_file_path,
        random_seed,
        results_dir):

    #Recommended format: source <doubleunderscore> data(Eg. source__data)
    model_name = '_'.join(sources)+'__'+virus_type
    # model_name = 'custom__name'

    # Filter input data for each virus type
    filtered_df = filter_virus_data(combined_data, sources, virus_type, ignore_mutations_less_than)

    # Ensemble models
    ensemble(
        filtered_df, 
        model_name, 
        results_dir, 
        write_log_file,
        passes, 
        iterations, 
        num_models,
        num_topics,
        alpha,
        beta,
        tuned_params_from_gridsearch,
        load_elda_model_from_disk,
        elda_model_file_path,
        random_seed)


def run_virus_tuned_train(
    sources = c.VIRUS_DATA_SOURCE, 
    virus_types = c.VIRUS_TYPE, 
    ignore_mutations_less_than = c.MIN_MUTATION_COUNT,
    write_log_file = c.ENABLE_LOG,
    passes = c.TUNED_PASSES, 
    iterations = c.TUNED_ITERATIONS, 
    num_trainings = c.TUNED_TRANINGS,
    num_topics = c.TUNED_NUM_TOPICS,
    alpha = c.TUNED_ALPHA,
    beta = c.TUNED_BETA,
    tuned_params_from_gridsearch = c.TUNED_PARAMS_FROM_GRIDSEARCH,
    random_seed = c.RANDOM_SEED,
    results_dir = c.RESULTS_DIR_VIRUS):

    # Load combined data generated by run_preprocess
    combined_data = load_virus_data()

    for virus_type in virus_types:
        run_tuned_train_virus_type(
            combined_data, 
            sources, 
            virus_type,
            ignore_mutations_less_than,
            write_log_file,
            passes,
            iterations,
            num_topics,
            alpha,
            beta,
            tuned_params_from_gridsearch,
            random_seed,
            results_dir)
    
    # Training with tuned parameters
    for i in range(num_trainings-1):
        random_seed = random.randint(0,10000)
        for virus_type in virus_types:
            run_tuned_train_virus_type(
                combined_data, 
                sources, 
                virus_type,
                ignore_mutations_less_than,
                write_log_file,
                passes,
                iterations,
                num_topics,
                alpha,
                beta,
                tuned_params_from_gridsearch,
                random_seed,
                results_dir)


def run_tuned_train_virus_type(
    combined_data, 
    sources, 
    virus_type,
    ignore_mutations_less_than,
    write_log_file,
    passes,
    iterations,
    num_topics,
    alpha,
    beta,
    tuned_params_from_gridsearch,
    random_seed,
    results_dir):

    #Recommended format: source <doubleunderscore> data(Eg. source__data)
    model_name = '_'.join(sources)+'__'+virus_type
    # model_name = 'custom__name'

    # Filter input data for each virus type
    filtered_df = filter_virus_data(combined_data, sources, virus_type, ignore_mutations_less_than)

    # Apply tuned hyperparameters to get tuned model
    tuned_train(
        filtered_df, 
        model_name, 
        results_dir, 
        write_log_file,
        passes,
        iterations,
        num_topics,
        alpha,
        beta,
        tuned_params_from_gridsearch,
        random_seed)


def run_virus_combine_signatures(    
    sources = c.VIRUS_DATA_SOURCE, 
    virus_types = c.VIRUS_TYPE, 
    write_log_file = c.ENABLE_LOG,
    cosine_sim_greater_than = c.COMBINE_SIGNATURES_COSINE_SIMILARITY,
    results_dir = c.RESULTS_DIR_VIRUS
    ):
    
    # Ensemble with tuned parameters
    for virus_type in virus_types:
        run_combine_signatures_virus_type(sources, virus_type, write_log_file, cosine_sim_greater_than, results_dir)


def run_combine_signatures_virus_type(sources, virus_type, write_log_file, cosine_sim_greater_than, results_dir):

    #Recommended format: source <doubleunderscore> data(Eg. source__type)
    model_name = '_'.join(sources)+'__'+virus_type
    # model_name = 'custom__name'

    signature_path = results_dir+'/'+c.TUNED_TRAIN_DIR+'/'+model_name+'/'

    # Combine signatures using cosine similarity
    combined_signature = combine_signatures(
        signature_path, 
        model_name, 
        write_log_file, 
        cosine_sim_greater_than, 
        )


def run_gridsearch_iterations_virus(
    sources = c.VIRUS_DATA_SOURCE, 
    virus_types = c.VIRUS_TYPE, 
    ignore_mutations_less_than = c.MIN_MUTATION_COUNT,
    write_log_file = c.ENABLE_LOG,
    iterations_range = c.GRIDSEARCH_ITERATIONS_RANGE, 
    num_topics = c.TUNED_NUM_TOPICS,
    random_seed = c.RANDOM_SEED,
    results_dir = c.RESULTS_DIR_VIRUS
    ):

    # Load combined data generated by run_preprocess
    combined_data = load_virus_data()

    for virus_type in virus_types:
        run_gridsearch_iterations_virus_type(
            combined_data, 
            sources, 
            virus_type,
            ignore_mutations_less_than,
            write_log_file,
            iterations_range,
            num_topics,
            random_seed,
            results_dir)

def run_gridsearch_iterations_virus_type(
    combined_data, 
    sources, 
    virus_type,
    ignore_mutations_less_than,
    write_log_file,
    iterations_range,
    num_topics,
    random_seed,
    results_dir):

    #Recommended format: source <doubleunderscore> data(Eg. source__data)
    model_name = '_'.join(sources)+'__'+virus_type
    # model_name = 'custom__name'

    # Filter input data for each virus type
    filtered_df = filter_virus_data(combined_data, sources, virus_type, ignore_mutations_less_than)

    # Apply tuned hyperparameters to get tuned model
    gridsearch_iterations(
        filtered_df, 
        model_name, 
        results_dir,
        write_log_file,
        iterations_range,
        num_topics,
        random_seed)